<ng-template #btnTpl let-i let-btn="btn" let-index="index">
  <ng-container *ngIf="!btn.tooltip">
    <ng-template [ngTemplateOutlet]="btnItemTpl" [ngTemplateOutletContext]="{ $implicit: i, btn: btn, index: index }"></ng-template>
  </ng-container>
  <span *ngIf="btn.tooltip" nz-tooltip [nzTooltipTitle]="btn.tooltip">
    <ng-template [ngTemplateOutlet]="btnItemTpl" [ngTemplateOutletContext]="{ $implicit: i, btn: btn, index: index }"></ng-template>
  </span>
</ng-template>
<ng-template #btnItemTpl let-i let-btn="btn" let-index="index">
  <a
    *ngIf="btn.pop"
    nz-popconfirm
    [nzPopconfirmTitle]="isFunction(btn.pop.title) ? btn.pop.title(i, index) : btn.pop.title"
    [nzIcon]="btn.pop.icon"
    [nzCondition]="btn.pop.condition(i)"
    [nzCancelText]="btn.pop.cancelText"
    [nzOkText]="btn.pop.okText"
    [nzOkType]="btn.pop.okType"
    (nzOnConfirm)="_btnClick(i, btn, null, index)"
    class="st__btn-text"
  >
    <ng-template [ngTemplateOutlet]="btnTextTpl" [ngTemplateOutletContext]="{ $implicit: i, btn: btn }"></ng-template>
  </a>
  <a *ngIf="!btn.pop" (click)="_btnClick(i, btn, $event, index)" class="st__btn-text">
    <ng-template [ngTemplateOutlet]="btnTextTpl" [ngTemplateOutletContext]="{ $implicit: i, btn: btn }"></ng-template>
  </a>
</ng-template>
<ng-template #btnTextTpl let-i let-btn="btn" let-index="index">
  <ng-container *ngIf="btn.icon">
    <i
      *ngIf="!btn.icon.iconfont"
      nz-icon
      [nzType]="btn.icon.type"
      [nzTheme]="btn.icon.theme"
      [nzSpin]="btn.icon.spin"
      [nzTwotoneColor]="btn.icon.twoToneColor"
    ></i>
    <i *ngIf="btn.icon.iconfont" nz-icon [nzIconfont]="btn.icon.iconfont"></i>
  </ng-container>
  <ng-container [ngSwitch]="true">
    <ng-template [ngSwitchCase]="!!(i._button && i._button[btn.text] && i._button[btn.text].delay)">
      {{'Recover' | internalI18n}}
      <nz-spin *ngIf="i._button && i._button[btn.text] && i._button[btn.text].delay" nzSimple [nzIndicator]="btnDelayLoadingTpl" class="st__btn-loading"></nz-spin>
      <ng-template #btnDelayLoadingTpl><i class="st__delay-icon anticon-spin"></i></ng-template>
    </ng-template>
    <ng-template [ngSwitchCase]="!!(i._button && i._button[btn.text] && i._button[btn.text].loading)">
      {{'Loading' | internalI18n}}
      <nz-spin *ngIf="i._button && i._button[btn.text] && i._button[btn.text].loading" nzSimple [nzIndicator]="btnLoadingTpl" class="st__btn-loading"></nz-spin>
      <ng-template #btnLoadingTpl><i nz-icon nzType="loading"></i></ng-template>
    </ng-template>
    <ng-template ngSwitchDefault>
      <span [innerHTML]="_btnText(i, btn)" [ngClass]="{ 'pl-xs': btn.icon }"></span>
    </ng-template>
  </ng-container>
</ng-template>
<ng-template #titleTpl let-i>
  <span [innerHTML]="i._text"></span>
  <small *ngIf="i.optional" class="st__head-optional" [innerHTML]="i.optional"></small>
  <i *ngIf="i.optionalHelp" class="st__head-tip" nz-tooltip [nzTooltipTitle]="i.optionalHelp" nz-icon nzType="question-circle"></i>
</ng-template>
<ng-template #chkAllTpl let-custom>
  <label
    nz-checkbox
    class="st__checkall"
    [nzDisabled]="_allCheckedDisabled"
    [(ngModel)]="_allChecked"
    [nzIndeterminate]="_indeterminate"
    (ngModelChange)="_checkAll()"
    [class.ant-table-selection-select-all-custom]="custom"
  ></label>
</ng-template>
<nz-table
  #table
  [nzData]="_data"
  [(nzPageIndex)]="pi"
  (nzPageIndexChange)="_change('pi');piChange.emit($event)"
  [(nzPageSize)]="ps"
  (nzPageSizeChange)="_change('ps');psChange.emit($event)"
  [nzTotal]="total"
  [nzShowPagination]="loadOnScroll ? false : _isPagination"
  [nzFrontPagination]="false"
  [nzSize]="size"
  [nzLoading]="showLoading('nz-table')"
  [nzLoadingDelay]="loadingDelay"
  [nzLoadingIndicator]="loadingIndicator"
  [nzTitle]="header"
  [nzFooter]="footer"
  [nzScroll]="scroll"
  [nzVirtualItemSize]="virtualItemSize"
  [nzVirtualMaxBufferPx]="virtualMaxBufferPx"
  [nzVirtualMinBufferPx]="virtualMinBufferPx"
  [nzVirtualForTrackBy]="virtualForTrackBy"
  [nzNoResult]="noResult"
  [nzPageSizeOptions]="page.pageSizes"
  [nzShowQuickJumper]="page.showQuickJumper"
  [nzShowSizeChanger]="page.showSize"
  [nzPaginationPosition]="page.position"
  [class.st__cdk-viewport-scroll-y]="table.scrollY && table.verticalScrollBarWidth !== 0"
  [nzShowTotal]="totalTpl"
  [nzWidthConfig]="widthConfig"
  fixScrollingX
  nz-resizable
>
  <thead class="st__head">
    <tr *ngFor="let row of _headers; let rowFirst = first"  [class.st-has-filter]="showFilters">
      <th *ngIf="rowFirst && showCheckbox" [nzWidth]="size === 'small' ? '28px' : '50px'" class="text-center" [attr.rowspan]="_headers.length" [nzLeft]="true">
        <ng-container *ngIf="checkboxSelections.length === 0">
          <ng-template [ngTemplateOutlet]="chkAllTpl" [ngTemplateOutletContext]="{ $implicit: false }"> </ng-template>
        </ng-container>
        <div *ngIf="checkboxSelections.length > 0" class="ant-table-selection">
          <ng-template [ngTemplateOutlet]="chkAllTpl" [ngTemplateOutletContext]="{ $implicit: true }"> </ng-template>
          <div
            *ngIf="checkboxSelections.length"
            nz-dropdown
            nzPlacement="bottomLeft"
            [nzDropdownMenu]="selectionMenu"
            class="ant-table-selection-down st__checkall-selection"
          >
            <i nz-icon nzType="down"></i>
          </div>
          <nz-dropdown-menu #selectionMenu="nzDropdownMenu">
            <ul nz-menu class="ant-table-selection-menu">
              <li nz-menu-item *ngFor="let rw of checkboxSelections" (click)="_rowSelection(rw)" [innerHTML]="rw.text"></li>
            </ul>
          </nz-dropdown-menu>
        </div>
      </th>
      <th *ngIf="rowFirst && expand" [nzWidth]="size === 'small' ? '28px' : '50px'" [attr.rowspan]="_headers.length" [nzLeft]="true"></th>
      <ng-container *ngFor="let h of getEnabledColumns(row, 'column', 'header'); let index = index">
        <th
          *ngIf="h?.column?.type !== 'action'; else notResizable"
          [attr.colspan]="h.colSpan"
          [attr.rowspan]="h.column.type === 'action' ? _headers.length + (showFilters ? 1 : 0) : h.rowSpan"
          [nzWidth]="h.column.width"
          [nzLeft]="!!h.column._left"
          [nzRight]="!!h.column._right"
          [class.st-column-action]="h.column.type === 'action'"
          [ngClass]="h.column.className"
          [attr.data-col]="h.column.indexKey"
          [nzShowSort]="h.column._sort.enabled"
          [nzSortOrder]="h.column._sort.default"
          (nzSortOrderChange)="sort(h.column, index, $event)"
          nz-resizable
          (nzResizeEnd)="onResize($event, h.column)"
        >
          <ng-template #renderTitle [ngTemplateOutlet]="h.column.__renderTitle" [ngTemplateOutletContext]="{ $implicit: h.column, index: index }"></ng-template>
          <ng-container *ngIf="!h.column.__renderTitle; else renderTitle">
            <ng-container [ngSwitch]="h.column.type">
              <ng-container *ngSwitchCase="'action'">
                <div class="d-flex justify-content-between">
                  <span>{{ 'Action' | translate }}</span>
                  <div class="d-flex align-items-center">
                    <a nz-button [nzSize]="size" nzType="link" *ngIf="showFilters" (click)="resetFilters()">Reset</a>
                    <column-config [configName]="columnSettingName"></column-config>
                  </div>
                </div>
              </ng-container>
              <ng-container *ngSwitchDefault>
                <ng-template [ngTemplateOutlet]="titleTpl" [ngTemplateOutletContext]="{ $implicit: h.column.title }"></ng-template>
              </ng-container>
            </ng-container>
          </ng-container>
          <nz-resize-handle nzDirection="right">
            <div class="resize-trigger"></div>
          </nz-resize-handle>
        </th>
        <ng-template #notResizable>
          <th
            [attr.colspan]="h.colSpan"
            [attr.rowspan]="h.column.type === 'action' ? _headers.length + (showFilters ? 1 : 0) : h.rowSpan"
            [nzWidth]="h.column.width"
            [nzLeft]="!!h.column._left"
            [nzRight]="!!h.column._right"
            [class.st-column-action]="h.column.type === 'action'"
            [ngClass]="h.column.className"
            [attr.data-col]="h.column.indexKey"
            [nzShowSort]="h.column._sort.enabled"
            [nzSortOrder]="h.column._sort.default"
            (nzSortOrderChange)="sort(h.column, index, $event)"
          >
            <ng-template #renderTitle [ngTemplateOutlet]="h.column.__renderTitle" [ngTemplateOutletContext]="{ $implicit: h.column, index: index }"></ng-template>
            <ng-container *ngIf="!h.column.__renderTitle; else renderTitle">
              <ng-container [ngSwitch]="h.column.type">
                <ng-container *ngSwitchCase="'action'">
                  <div class="d-flex justify-content-between">
                    <span>{{ 'Action' | translate }}</span>
                    <div class="d-flex align-items-center">
                      <a nz-button class="mr-sm" [nzSize]="size" nzType="link" *ngIf="showFilters" (click)="resetFilters()" style="padding-bottom: 3px;">{{ 'Reset' | internalI18n }}</a>
                      <column-config [configName]="columnSettingName"></column-config>
                    </div>
                  </div>
                </ng-container>
                <ng-container *ngSwitchDefault>
                  <ng-template [ngTemplateOutlet]="titleTpl" [ngTemplateOutletContext]="{ $implicit: h.column.title }"></ng-template>
                </ng-container>
              </ng-container>
            </ng-container>
          </th>
        </ng-template>
      </ng-container>
    </tr>
    <tr class="st-thead-row-filter st-has-filter"
        *ngIf="showFilters && getEnabledColumns(_filterRow, 'column', 'filter')?.length">
      <th *ngIf="showCheckbox" [nzLeft]="true"></th>
      <th *ngIf="expand" [nzLeft]="true"></th>
      <th *ngFor="let i of getEnabledColumns(_filterRow, 'column', 'filter'); index as index"
          [nzLeft]="!!i.column._left"
          [nzRight]="!!i.column._right"
          (keyup.enter)="_filterConfirm(i.column)">
        <ng-container [ngSwitch]="i.column.filter?.type">
          <ng-container *ngSwitchCase="i.column.filter?.type === null ? null : 'nevermatch'">
            <input type="text" nzSize="small" nz-input disabled>
          </ng-container>
          <ng-container *ngSwitchCase="'select'">
            <nz-select
              class="width-100"
              [(ngModel)]="(i.column.filter?.menus)[0].value"
              (ngModelChange)="_filterConfirm(i.column)"
              nzShowSearch
              [nzOptions]="getFilterOptions(i.column, index)"
              nzAllowClear
              nzSize="small"
            ></nz-select>
          </ng-container>
          <ng-container *ngSwitchCase="'autocomplete'">
            <input
              type="text"
              [nzAutocomplete]="auto"
              #autocompleteInput
              [(ngModel)]="(i.column.filter?.menus)[0].value"
              (ngModelChange)="_filterConfirm(i.column)"
              nz-input
              nzSize="small"
            />
            <nz-autocomplete [nzDataSource]="getFilterOptions(i.column, index, autocompleteInput.value)" nzBackfill #auto></nz-autocomplete>
          </ng-container>
          <ng-container *ngSwitchCase="'date'">
            <nz-date-picker nzSize="small" class="width-100" [(ngModel)]="(i.column.filter?.menus)[0].value" (ngModelChange)="_filterConfirm(i.column)"></nz-date-picker>
          </ng-container>
          <ng-container *ngSwitchCase="'date-range'">
            <nz-range-picker wholeDayRange nzSize="small" nzFormat="yyyy-MM-dd" class="width-100" [(ngModel)]="(i.column.filter?.menus)[0].value" (ngModelChange)="_filterConfirm(i.column)"></nz-range-picker>
          </ng-container>
          <ng-container *ngSwitchCase="'number'">
            <co-st-number-input [(ngModel)]="(i.column.filter?.menus)[0].value" (ngModelChange)="_filterConfirm(i.column)"></co-st-number-input>
          </ng-container>
          <ng-template
            *ngSwitchCase="'widget'"
            co-st-va-widget-host
            [(value)]="(i.column.filter?.menus)[0].value"
            (valueChange)="_filterConfirm(i.column)"
            [column]="i.column"
          ></ng-template>
          <!-- 'keyword' type treat as default filter -->
          <ng-container *ngSwitchDefault>
            <input type="text" nz-input
                   nzSize="small"
                   [(ngModel)]="(i.column.filter?.menus)[0].value"
                   (ngModelChange)="ifNeedFilterConfirm($event) && _filterConfirm(i.column)" />
          </ng-container>
        </ng-container>
      </th>
    </tr>
  </thead>
  <tbody class="st__body">
    <ng-container *ngIf="!showLoading()">
      <ng-template [ngTemplateOutlet]="bodyHeader" [ngTemplateOutletContext]="{ $implicit: _statistical }"></ng-template>
    </ng-container>
    <ng-template #bodyTpl let-i let-index="index">
      <tr
        [attr.data-index]="index"
        (click)="_rowClick($event, i, index)"
        [class.st-row-odd]="index % 2 === 1"
        [class.st-row-child-expanded]="i._innerExpandRow"
        [ngClass]="i._rowClassName"
        [stRowSelected]="i"
        [stRowSelectedIndex]="index"
        [hidden]="i._innerExpandRow && !i._innerExpanded"
      >
        <td
          *ngIf="showCheckbox"
          [nzLeft]="true"
          class="text-center">
          <label *ngIf="!i._innerExpandRow" nz-checkbox [nzDisabled]="i.disabled" [ngModel]="i.checked" (ngModelChange)="_checkSelection(i, $event, index)"></label>
        </td>
        <td
          *ngIf="expand"
          [nzShowExpand]="expand && i.showExpand !== false"
          [nzExpand]="i.expand"
          (nzExpandChange)="_expandChange(i, $event)"
          [nzLeft]="true"
          nzWidth="50px"
        ></td>
        <!-- 展示状态 -->
        <ng-container *ngFor="let c of _columns; let cIdx = index">
        <td *ngIf="c.columnShow !== false" [nzLeft]="!!c._left" [nzRight]="!!c._right" [ngClass]="columnClass(c)" [attr.colspan]="c.colSpan">
          <span *ngIf="responsive" class="ant-table-rep__title">
            <ng-template [ngTemplateOutlet]="titleTpl" [ngTemplateOutletContext]="{ $implicit: c.title }"></ng-template>
          </span>
          <span data-cell-span>
            <ng-template #render [ngTemplateOutlet]="c.__render" [ngTemplateOutletContext]="{ $implicit: i, index: index, column: c }"></ng-template>
            <ng-container *ngIf="!c.__render; else render">
              <!-- 常规展示 -->
              <ng-container [ngSwitch]="c.type" *ngIf="['no'].includes(c.type) || !i._editing || c.uneditable; else editing">
                <label *ngSwitchCase="'radio'" nz-radio [nzDisabled]="i.disabled" [ngModel]="i.checked" (ngModelChange)="_refRadio($event, i)"></label>
                <a *ngSwitchCase="'link'" (click)="_click($event, i, c)" [innerHTML]="i._values[cIdx]?._text"></a>
                <ng-container *ngIf="i._values[cIdx]?.text">
                  <nz-tag *ngSwitchCase="'tag'" [nzColor]="i._values[cIdx].color">
                    <span [innerHTML]="i._values[cIdx]?._text"></span>
                  </nz-tag>
                  <nz-badge *ngSwitchCase="'badge'" [nzStatus]="i._values[cIdx].color" [nzText]="i._values[cIdx]?.text"></nz-badge>
                </ng-container>
                <ng-template *ngSwitchCase="'widget'" st-widget-host [record]="i" [column]="c"></ng-template>
                <span *ngSwitchDefault [innerHTML]="i._values[cIdx]?._text" [attr.title]="isTruncate(c) ? htmlToText(i._values[cIdx]?.text) : null"></span>
              </ng-container>
              <!-- 编辑 -->
              <ng-template #editing>
                <!-- 这里和过滤器共用类型 -->
                <ng-container [ngSwitch]="c.filter.type" *ngIf="!['action'].includes(c.type)">
                  <nz-date-picker *ngSwitchCase="'date'" [(ngModel)]="i._values[cIdx].value" class="width-100"></nz-date-picker>
                  <input *ngSwitchDefault type="text" nz-input [(ngModel)]="i._values[cIdx].value" />
                </ng-container>
              </ng-template>
              <!-- button -->
              <ng-container *ngFor="let btn of _validBtns(c.buttons, i, c, true); let last = last; trackBy: btnTrackByFn">
                <a *ngIf="btn.children.length > 0" nz-dropdown [nzDropdownMenu]="btnMenu" [className]="btn._className || ''" nzOverlayClassName="st__btn-sub">
                  <ng-container *ngIf="_btnText(i, btn); else ellipsisIcon">
                    <span [innerHTML]="_btnText(i, btn)"></span>
                    <i nz-icon nzType="down"></i>
                  </ng-container>
                  <ng-template #ellipsisIcon>
                    <span style="position: relative;font-weight: bold;">
                      {{ 'More' | internalI18n }}
                      <i style="display: inline-block;height: 11px;overflow: hidden;">
                        <svg t="1611647895247" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="13977" width="14" height="14" style="fill: #1890ff;"><path d="M454.188 785.022c-145.192-150.177-290.378-300.353-435.422-450.526-59.842-61.836 37.327-154.021 97.313-91.899 129.23 133.647 258.318 267.296 387.548 400.868 133.646-134.287 267.436-268.574 401.083-402.934 60.84-61.123 158.011 31.060 97.244 91.971-150.105 150.89-300.279 301.703-450.454 452.521-24.933 24.934-72.666 25.575-97.311 0z" p-id="13978"></path></svg>
                      </i>
                    </span>
                  </ng-template>
                </a>
                <nz-dropdown-menu #btnMenu="nzDropdownMenu">
                  <ul nz-menu>
                    <ng-container *ngFor="let subBtn of _validBtns(btn.children, i, c); trackBy: btnTrackByFn">
                      <li *ngIf="subBtn.type !== 'divider'" nz-menu-item [class.st__btn-disabled]="subBtn._disabled">
                        <ng-template [ngTemplateOutlet]="btnTpl" [ngTemplateOutletContext]="{ $implicit: i, btn: subBtn, index: index }"></ng-template>
                      </li>
                      <li *ngIf="subBtn.type === 'divider'" nz-menu-divider></li>
                    </ng-container>
                  </ul>
                </nz-dropdown-menu>
                <span
                  *ngIf="btn.children.length == 0"
                  [ngClass]="btn._className || ''"
                  (click)="!buttonPropagation && $event.stopPropagation()"
                  [class.st__btn-disabled]="btn._disabled"
                >
                  <ng-template [ngTemplateOutlet]="btnTpl" [ngTemplateOutletContext]="{ $implicit: i, btn: btn, index: index }"></ng-template>
                </span>
                <nz-divider *ngIf="!last" nzType="vertical"></nz-divider>
              </ng-container>
              <ng-template
                [ngIf]="!c.__renderExpanded"
                [ngTemplateOutlet]="c.__renderExpanded"
                [ngTemplateOutletContext]="{ $implicit: i, index: index, column: c }"
              ></ng-template>
            </ng-container>
          </span>
        </td>
        </ng-container>
      </tr>
      <tr [nzExpand]="i.expand">
        <ng-template [ngTemplateOutlet]="expand" [ngTemplateOutletContext]="{ $implicit: i, index: index }"></ng-template>
      </tr>
    </ng-template>
    <ng-container *ngIf="!virtualScroll">
      <ng-container *ngFor="let i of _data; let index = index">
        <ng-template [ngTemplateOutlet]="bodyTpl" [ngTemplateOutletContext]="{ $implicit: i, index: index }"> </ng-template>
      </ng-container>
    </ng-container>
    <ng-container *ngIf="virtualScroll && _data?.length">
      <ng-template nz-virtual-scroll let-i let-index="index">
        <ng-template [ngTemplateOutlet]="bodyTpl" [ngTemplateOutletContext]="{ $implicit: i, index: index }"> </ng-template>
      </ng-template>
    </ng-container>
    <ng-container *ngIf="!showLoading()">
      <ng-template [ngTemplateOutlet]="body" [ngTemplateOutletContext]="{ $implicit: _statistical }"></ng-template>
    </ng-container>
  </tbody>
  <ng-template #totalTpl let-range="range" let-total>{{ renderTotal(total, range) }}</ng-template>
</nz-table>
<div *ngIf="showLoading('load-on-scroll')" class="st__scroll-loading">
  <nz-spin></nz-spin>
</div>
